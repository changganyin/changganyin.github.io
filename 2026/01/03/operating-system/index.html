<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Operating System, Blog">
    <meta name="description" content="华科《操作系统实验》">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Operating System | Changgan Yin&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body{
            background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Changgan Yin&#39;s Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Changgan Yin&#39;s Blog</div>
        <div class="logo-desc">
            
            Changgan Yin&#39;s Blog
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/changganyin/changganyin.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/changganyin/changganyin.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://mp-b6045dcf-2927-4865-9325-f14fa0979d3b.cdn.bspapp.com/classss.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Operating System</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/HUST/">
                                <span class="chip bg-color">HUST</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Study/" class="post-category">
                                Study
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2026-01-03
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2026-01-03
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    8.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    40 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="实验一">实验一</h2>
<h3 id="task-1-编译新内核">task_1 编译新内核</h3>
<ol>
<li>从 <a target="_blank" rel="noopener" href="http://kernel.org">kernel.org</a> 下载新内核</li>
<li>安装乱七八糟的包</li>
<li>sudo make menuconfig 打开配置内核的图形界面，然后 Save Exit</li>
<li>修改 .config：<code>CONFIG_SYSTEM_TRUSTED_KEYS=""</code>, <code>CONFIG_SYSTEM_REVOCATION_KEYS=""</code></li>
<li>make -j16 编译</li>
<li>make modules_install 安装 modules</li>
<li>make install 安装内核</li>
</ol>
<h3 id="task-2-添加新系统调用">task_2 添加新系统调用</h3>
<ul>
<li>旧内核版本：6.14.0.37-generic</li>
<li>新内核版本：6.17.12</li>
</ul>
<p>修改三个文件：</p>
<ul>
<li>arch/x86/entry/syscalls/syscall_64.tbl</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">548 common Max    sys_Max</span><br><span class="line">549 common GetPID sys_GetPID</span><br><span class="line">550 common GetCMD sys_GetCMD</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>include/linux/syscalls.h</li>
</ul>
<figure class="highlight h"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">asmlinkage <span class="type">long</span> <span class="title function_">sys_Max</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span>;</span><br><span class="line">asmlinkage <span class="type">long</span> <span class="title function_">sys_GetPID</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">asmlinkage <span class="type">long</span> <span class="title function_">sys_GetCMD</span><span class="params">(<span class="type">char</span> __user *buf, <span class="type">int</span> len)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>kernel/sys.c</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Max: 比较三个整数，返回最大值</span></span><br><span class="line">SYSCALL_DEFINE3(Max, <span class="type">int</span>, a, <span class="type">int</span>, b, <span class="type">int</span>, c)</span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> max = a;</span><br><span class="line">    <span class="keyword">if</span> (b &gt; max) max = b;</span><br><span class="line">    <span class="keyword">if</span> (c &gt; max) max = c;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">"[MyCall] Max(%d, %d, %d) = %d\n"</span>, a, b, c, max);</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. GetPID: 获得当前进程 ID</span></span><br><span class="line">SYSCALL_DEFINE0(GetPID)</span><br><span class="line">{</span><br><span class="line">    printk(KERN_INFO <span class="string">"[MyCall] GetPID called. PID: %d\n"</span>, current-&gt;pid);</span><br><span class="line">    <span class="keyword">return</span> current-&gt;pid;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. GetCMD: 获得当前进程名称</span></span><br><span class="line">SYSCALL_DEFINE2(GetCMD, <span class="type">char</span> __user *, buf, <span class="type">int</span>, len)</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 定义一个内核栈上的临时缓冲区</span></span><br><span class="line">    <span class="comment">// TASK_COMM_LEN 通常是 16，定义在 &lt;linux/sched.h&gt; 中</span></span><br><span class="line">    <span class="type">char</span> comm[TASK_COMM_LEN];</span><br><span class="line">    <span class="type">int</span> comm_len;</span><br><span class="line"></span><br><span class="line">    get_task_comm(comm, current);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 计算长度</span></span><br><span class="line">    comm_len = <span class="built_in">strlen</span>(comm) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 检查用户缓冲区大小</span></span><br><span class="line">    <span class="keyword">if</span> (len &lt; comm_len)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 从“内核栈”拷贝到“用户空间”，这是被允许的</span></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buf, comm, comm_len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* --- My Custom System Calls End --- */</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="task-4-显示系统信息">task_4 显示系统信息</h3>
<p>sys_monitor.sh</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义颜色变量，为了让输出好看一点</span></span><br><span class="line"><span class="comment"># 用 ANSI 转义码来实现彩色高亮</span></span><br><span class="line">RED=<span class="string">'\033[0;31m'</span></span><br><span class="line">GREEN=<span class="string">'\033[0;32m'</span></span><br><span class="line">BLUE=<span class="string">'\033[0;34m'</span></span><br><span class="line">BOLD=<span class="string">'\033[1m'</span></span><br><span class="line">NC=<span class="string">'\033[0m'</span> <span class="comment"># No Color，用完颜色记得清除，不然会乱</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"<span class="variable">${BLUE}</span><span class="variable">${BOLD}</span>=== Linux系统监测脚本运行报告 ===<span class="variable">${NC}</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"----------------------------------------"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= 1. 系统基本信息部分 =================</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"<span class="variable">${GREEN}</span><span class="variable">${BOLD}</span>1. 系统基本信息部分<span class="variable">${NC}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 获取系统名称</span></span><br><span class="line"><span class="comment"># 有的系统没有 lsb_release，所以先读文件试试，不行再用 uname</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/os-release ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 读取配置文件里的变量</span></span><br><span class="line">    <span class="built_in">source</span> /etc/os-release</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"系统名称: <span class="variable">$PRETTY_NAME</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"系统名称: <span class="subst">$(uname -s)</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 内核版本</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"内核版本: <span class="subst">$(uname -r)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 运行时间</span></span><br><span class="line"><span class="comment"># 使用 -p 参数让时间显示更人性化 (pretty format)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"运行时间: <span class="subst">$(uptime -p)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 当前用户</span></span><br><span class="line"><span class="comment"># id -u 可以查到用户的 UID，whoami 查名字</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"当前用户: <span class="subst">$(whoami)</span> (UID: <span class="subst">$(id -u)</span>)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. CPU信息</span></span><br><span class="line"><span class="comment"># 直接去 /proc/cpuinfo 里 grep 找型号，uniq 去重只显示一行</span></span><br><span class="line"><span class="comment"># xargs 用来去除多余的空格</span></span><br><span class="line">CPU_MODEL=$(grep <span class="string">'model name'</span> /proc/cpuinfo | <span class="built_in">head</span> -1 | <span class="built_in">cut</span> -d: -f2 | xargs)</span><br><span class="line"><span class="comment"># 统计 processor 出现的次数就知道有几个核了</span></span><br><span class="line">CPU_CORES=$(grep -c <span class="string">'processor'</span> /proc/cpuinfo)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"CPU信息 : <span class="variable">$CPU_MODEL</span> (<span class="variable">$CPU_CORES</span> 核心)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 内存信息</span></span><br><span class="line"><span class="comment"># 注意：这里加了 LC_ALL=C，强制命令输出英文，</span></span><br><span class="line"><span class="comment"># 否则如果系统是中文环境，grep "Mem" 可能会失败，导致变量为空报错</span></span><br><span class="line">MEM_TOTAL=$(LC_ALL=C free -h | grep Mem | awk <span class="string">'{print $2}'</span>)</span><br><span class="line">MEM_USED=$(LC_ALL=C free -h | grep Mem | awk <span class="string">'{print $3}'</span>)</span><br><span class="line">MEM_AVAIL=$(LC_ALL=C free -h | grep Mem | awk <span class="string">'{print $7}'</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"内存信息: 总共 <span class="variable">$MEM_TOTAL</span>, 已用 <span class="variable">$MEM_USED</span>, 可用 <span class="variable">$MEM_AVAIL</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= 2. 系统状态部分 =================</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"<span class="variable">${GREEN}</span><span class="variable">${BOLD}</span>2. 系统状态部分<span class="variable">${NC}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 系统负载</span></span><br><span class="line"><span class="comment"># 直接读取 /proc/loadavg 文件的系统平均负载数据</span></span><br><span class="line">LOAD_AVG=$(awk <span class="string">'{print $1", "$2", "$3}'</span> /proc/loadavg)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"系统负载: <span class="variable">$LOAD_AVG</span> (1, 5, 15分钟)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 当前时间</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"当前时间: <span class="subst">$(date <span class="string">"+%Y年%m月%d日 %H点%M分%S秒"</span>)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. CPU使用率</span></span><br><span class="line"><span class="comment"># 用 top 抓取一次状态 (-bn1)，然后用 sed 提取 id (idle 空闲率)</span></span><br><span class="line"><span class="comment"># 只要算出空闲率，用 100 减去它就是使用率了</span></span><br><span class="line">CPU_IDLE=$(top -bn1 | grep <span class="string">"Cpu(s)"</span> | sed <span class="string">"s/.*, *\([0-9.]*\)%* id.*/\1/"</span> | awk <span class="string">'{print $1}'</span>)</span><br><span class="line"><span class="comment"># 判断一下是否获取到了数值，防止计算报错</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$CPU_IDLE</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 用 bc 或者简单的 shell 算术运算</span></span><br><span class="line">    <span class="comment"># 这里为了兼容性，用 awk 来做减法</span></span><br><span class="line">    CPU_USAGE=$(awk <span class="string">"BEGIN {print 100 - <span class="variable">$CPU_IDLE</span>}"</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"CPU使用率: <span class="variable">${CPU_USAGE}</span>%"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"CPU使用率: 无法获取"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 内存使用率</span></span><br><span class="line"><span class="comment"># 为了计算百分比，这里用 bytes 为单位取数值 (free 不带 -h)</span></span><br><span class="line"><span class="comment"># 同样加上 LC_ALL=C 防止出错</span></span><br><span class="line">MEM_TOTAL_NUM=$(LC_ALL=C free | grep Mem | awk <span class="string">'{print $2}'</span>)</span><br><span class="line">MEM_USED_NUM=$(LC_ALL=C free | grep Mem | awk <span class="string">'{print $3}'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的 awk 用来做浮点数除法运算，保留两位小数</span></span><br><span class="line"><span class="comment"># 加上判断防止分母为 0 的情况</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$MEM_TOTAL_NUM</span>"</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$MEM_TOTAL_NUM</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    MEM_PERCENT=$(awk <span class="string">"BEGIN {printf \"%.2f\", <span class="variable">$MEM_USED_NUM</span> / <span class="variable">$MEM_TOTAL_NUM</span> * 100}"</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"内存使用率: <span class="variable">${MEM_PERCENT}</span>%"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"内存使用率: 无法计算"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= 3. 进程信息部分 =================</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"<span class="variable">${GREEN}</span><span class="variable">${BOLD}</span>3. 进程信息部分<span class="variable">${NC}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ps 命令自定义输出格式：PID, 用户, CPU占用, 内存占用, 命令名</span></span><br><span class="line"><span class="comment"># --sort 参数用来排序，-pcpu 表示按 CPU 降序，-pmem 表示按内存降序</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"<span class="variable">${BOLD}</span>CPU占用最高的5个进程:<span class="variable">${NC}</span>"</span></span><br><span class="line"><span class="comment"># head -n 6 是因为第一行是标题，所以取前6行就是 Top 5</span></span><br><span class="line">ps -eo pid,user,pcpu,pmem,<span class="built_in">comm</span> --<span class="built_in">sort</span>=-pcpu | <span class="built_in">head</span> -n 6 | awk <span class="string">'{printf "%-8s %-10s %-8s %-8s %s\n", $1, $2, $3"%", $4"%", $5}'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"<span class="variable">${BOLD}</span>内存占用最高的5个进程:<span class="variable">${NC}</span>"</span></span><br><span class="line">ps -eo pid,user,pcpu,pmem,<span class="built_in">comm</span> --<span class="built_in">sort</span>=-pmem | <span class="built_in">head</span> -n 6 | awk <span class="string">'{printf "%-8s %-10s %-8s %-8s %s\n", $1, $2, $3"%", $4"%", $5}'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"----------------------------------------"</span></span><br></pre></td></tr></tbody></table></figure>
<p><em>实验一截图</em><br>
![[Pasted image 20251223153920.png]]</p>
<h2 id="实验二">实验二</h2>
<h3 id="task-1-在-linux-下创建两个线程-a-和-b-循环输出数据或者字符串">task_1 在 Linux 下创建两个线程 A 和 B, 循环输出数据或者字符串</h3>
<p>task_1.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 A 的执行函数</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">ThreadAFunc</span><span class="params">(<span class="type">void</span>* arg)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; ++i) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"A:"</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">200000</span>); <span class="comment">// 暂停 0.2 秒 (200,000 微秒)</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 B 的执行函数</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">ThreadBFunc</span><span class="params">(<span class="type">void</span>* arg)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1000</span>; i &gt;= <span class="number">1</span>; --i) {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"B:"</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">200000</span>); <span class="comment">// 暂停 0.2 秒</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">pthread_t</span> threadA, threadB;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建线程 A</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_create</span>(&amp;threadA, <span class="literal">NULL</span>, ThreadAFunc, <span class="literal">NULL</span>) != <span class="number">0</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"Error creating thread A"</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建线程 B</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_create</span>(&amp;threadB, <span class="literal">NULL</span>, ThreadBFunc, <span class="literal">NULL</span>) != <span class="number">0</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"Error creating thread B"</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待线程结束</span></span><br><span class="line">    <span class="built_in">pthread_join</span>(threadA, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(threadB, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>g++ task_1.cpp -o task_1 -lpthread</p>
<ol>
<li>利用 <code>pthread</code> 库同时启动两个线程 A 和 B</li>
<li>线程 A：从 1 累加到 1000</li>
<li>线程 B：从 1000 递减到 1</li>
<li>每个循环均使用 <code>usleep(200000)</code> 暂停 <strong>0.2 秒</strong>，使两个线程在控制台交替输出</li>
<li><code>main</code> 函数使用 <code>pthread_join</code> 等待两个子线程全部执行完毕后才退出</li>
</ol>
<p><em>task_1 截图</em><br>
![[Pasted image 20251223154235.png]]</p>
<h3 id="task-2-在-linux-下创建父子进程-实现-wait-同步函数-理解父子进程同步">task_2 在 Linux 下创建父子进程，实现 wait 同步函数，理解父子进程同步</h3>
<p>task_2.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="type">pid_t</span> pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// Fork 失败</span></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"Fork failed!"</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// 子进程代码</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Child] I am the child process (PID: "</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">")."</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Child] Sleeping for 5 seconds..."</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Child] Woke up. Exiting with status 42."</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">42</span>); <span class="comment">// 子进程返回 42</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 父进程代码</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Parent] I am the parent process (PID: "</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">")."</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Parent] Created child process with PID: "</span> &lt;&lt; pid &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> status;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Parent] Waiting for child to exit..."</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待任意子进程结束</span></span><br><span class="line">        <span class="type">pid_t</span> child_pid = <span class="built_in">wait</span>(&amp;status);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">WIFEXITED</span>(status)) {</span><br><span class="line">            <span class="comment">// 子进程正常退出</span></span><br><span class="line">            <span class="type">int</span> exit_status = <span class="built_in">WEXITSTATUS</span>(status);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"[Parent] Child process "</span> &lt;&lt; child_pid &lt;&lt; <span class="string">" exited normally."</span> &lt;&lt; std::endl;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"[Parent] The return status is: "</span> &lt;&lt; exit_status &lt;&lt; std::endl;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"[Parent] Child process exited abnormally."</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>g++ task_2.cpp -o task_2</p>
<ol>
<li>调用 <code>fork()</code> 创建一个与父进程几乎完全一样的子进程。此时程序通过返回值 pid 分流：pid == 0：当前处于子进程环境; pid &gt; 0：当前处于父进程环境（返回值为子进程的 PID）</li>
<li>子进程行为：打印自身 PID 后进入 5 秒休眠，随后通过 <code>exit(42)</code> 退出并返回状态码 42</li>
<li><strong>父进程行为</strong>：调用 <code>wait(&amp;status)</code> 进入<strong>阻塞状态</strong>，等待子进程结束</li>
<li><strong>状态捕获</strong>：子进程退出后，父进程被唤醒，利用宏 <code>WIFEXITED</code> 确认子进程是正常退出的，并用 <code>WEXITSTATUS</code> 提取出子进程返回的数值 42</li>
</ol>
<p><em>task_2 截图</em><br>
![[Pasted image 20251223154345.png]]</p>
<h3 id="task-3-在-windows-下-利用线程实现并发画圆画方">task_3 在 Windows 下，利用线程实现并发画圆画方</h3>
<p>task_3.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PI 3.14159265</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局变量，用于窗口句柄</span></span><br><span class="line">HWND hGraphWindow = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 窗口过程函数 (处理窗口消息)</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowProc</span><span class="params">(HWND hwnd, UINT uMsg, WPARAM wParam,</span></span></span><br><span class="line"><span class="params"><span class="function">                            LPARAM lParam)</span> </span>{</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) {</span><br><span class="line">    <span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">        <span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> WM_PAINT: {</span><br><span class="line">        PAINTSTRUCT ps;</span><br><span class="line">        HDC hdc = <span class="built_in">BeginPaint</span>(hwnd, &amp;ps);</span><br><span class="line">        <span class="comment">// 这里什么都不做，留给线程去画</span></span><br><span class="line">        <span class="built_in">EndPaint</span>(hwnd, &amp;ps);</span><br><span class="line">    }</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hwnd, uMsg, wParam, lParam);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 专门用于创建和维护窗口的线程</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">WindowThread</span><span class="params">(LPVOID lpParam)</span> </span>{</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> CLASS_NAME[] = <span class="string">"Sample Window Class"</span>;</span><br><span class="line">    WNDCLASS wc = {};</span><br><span class="line">    wc.lpfnWndProc = WindowProc;</span><br><span class="line">    wc.hInstance = <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">    wc.lpszClassName = CLASS_NAME;</span><br><span class="line">    wc.hbrBackground = (HBRUSH)(COLOR_WINDOW + <span class="number">1</span>); <span class="comment">// 白色背景</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">RegisterClass</span>(&amp;wc);</span><br><span class="line"></span><br><span class="line">    hGraphWindow = <span class="built_in">CreateWindowEx</span>(<span class="number">0</span>, CLASS_NAME, <span class="string">"Concurrent Drawing Lab"</span>,</span><br><span class="line">                                  WS_OVERLAPPEDWINDOW | WS_VISIBLE, <span class="number">100</span>, <span class="number">100</span>,</span><br><span class="line">                                  <span class="number">800</span>, <span class="number">600</span>, <span class="comment">// 窗口位置和大小</span></span><br><span class="line">                                  <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hGraphWindow == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息循环</span></span><br><span class="line">    MSG msg = {};</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">GetMessage</span>(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>)) {</span><br><span class="line">        <span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">        <span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 A：画圆</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">DrawCircle</span><span class="params">(LPVOID lpParam)</span> </span>{</span><br><span class="line">    <span class="comment">// 等待窗口创建完毕</span></span><br><span class="line">    <span class="keyword">while</span> (hGraphWindow == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    HDC hdc = <span class="built_in">GetDC</span>(hGraphWindow);</span><br><span class="line">    <span class="type">int</span> centerX = <span class="number">300</span>;</span><br><span class="line">    <span class="type">int</span> centerY = <span class="number">300</span>;</span><br><span class="line">    <span class="type">int</span> radius = <span class="number">100</span>;</span><br><span class="line">    COLORREF color = <span class="built_in">RGB</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 红色</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">720</span>; ++i) {</span><br><span class="line">        <span class="type">double</span> angle = (<span class="type">double</span>)i * PI / <span class="number">360.0</span>;</span><br><span class="line">        <span class="type">int</span> x = centerX + (<span class="type">int</span>)(radius * <span class="built_in">cos</span>(angle));</span><br><span class="line">        <span class="type">int</span> y = centerY + (<span class="type">int</span>)(radius * <span class="built_in">sin</span>(angle));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y, color);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 画大一点点，防止看不清</span></span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x + <span class="number">1</span>, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y + <span class="number">1</span>, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x + <span class="number">1</span>, y + <span class="number">1</span>, color);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2</span>); <span class="comment">// 稍微快一点</span></span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">ReleaseDC</span>(hGraphWindow, hdc);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程 B：画正方形</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">DrawSquare</span><span class="params">(LPVOID lpParam)</span> </span>{</span><br><span class="line">    <span class="comment">// 等待窗口创建完毕</span></span><br><span class="line">    <span class="keyword">while</span> (hGraphWindow == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    HDC hdc = <span class="built_in">GetDC</span>(hGraphWindow);</span><br><span class="line">    <span class="type">int</span> centerX = <span class="number">600</span>;</span><br><span class="line">    <span class="type">int</span> centerY = <span class="number">300</span>;</span><br><span class="line">    <span class="type">int</span> sideLength = <span class="number">200</span>;</span><br><span class="line">    <span class="type">int</span> halfSide = sideLength / <span class="number">2</span>;</span><br><span class="line">    COLORREF color = <span class="built_in">RGB</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>); <span class="comment">// 蓝色</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> steps = <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义四个顶点的逻辑</span></span><br><span class="line">    <span class="comment">// 上边</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; steps; i++) {</span><br><span class="line">        <span class="type">int</span> x = (centerX - halfSide) + (<span class="type">int</span>)((<span class="type">double</span>)sideLength * i / steps);</span><br><span class="line">        <span class="type">int</span> y = centerY - halfSide;</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x + <span class="number">1</span>, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y + <span class="number">1</span>, color);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 右边</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; steps; i++) {</span><br><span class="line">        <span class="type">int</span> x = centerX + halfSide;</span><br><span class="line">        <span class="type">int</span> y = (centerY - halfSide) + (<span class="type">int</span>)((<span class="type">double</span>)sideLength * i / steps);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x + <span class="number">1</span>, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y + <span class="number">1</span>, color);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 下边</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; steps; i++) {</span><br><span class="line">        <span class="type">int</span> x = (centerX + halfSide) - (<span class="type">int</span>)((<span class="type">double</span>)sideLength * i / steps);</span><br><span class="line">        <span class="type">int</span> y = centerY + halfSide;</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x + <span class="number">1</span>, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y + <span class="number">1</span>, color);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 左边</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; steps; i++) {</span><br><span class="line">        <span class="type">int</span> x = centerX - halfSide;</span><br><span class="line">        <span class="type">int</span> y = (centerY + halfSide) - (<span class="type">int</span>)((<span class="type">double</span>)sideLength * i / steps);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x + <span class="number">1</span>, y, color);</span><br><span class="line">        <span class="built_in">SetPixel</span>(hdc, x, y + <span class="number">1</span>, color);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ReleaseDC</span>(hGraphWindow, hdc);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 1. 启动窗口线程</span></span><br><span class="line">    HANDLE hWinThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, WindowThread, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Waiting for window..."</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">while</span> (hGraphWindow == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">100</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Window created! Drawing..."</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 启动画图线程</span></span><br><span class="line">    HANDLE hThread1 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, DrawCircle, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    HANDLE hThread2 = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, DrawSquare, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待画图完成</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread1, INFINITE);</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread2, INFINITE);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Drawing finished. Close the window to exit."</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待窗口关闭</span></span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hWinThread, INFINITE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>g++ .\task_3.cpp -o task_3 -lgdi32</p>
<ol>
<li>通过 <code>CreateThread</code> 启动了一个专门的 <code>WindowThread</code> 线程，用于注册窗口类、创建 <code>HWND</code> 窗口并运行 <code>GetMessage</code> 消息循环</li>
<li>确认窗口句柄 <code>hGraphWindow</code> 有效后，同时启动两个绘图线程：<code>DrawCircle</code> 线程：利用三角函数 <code>cos</code> 和 <code>sin</code> 计算坐标，在窗口左侧绘制一个红色圆形；<code>DrawSquare</code> 线程：通过四个顺序执行的 <code>for</code> 循环计算线性坐标，在窗口右侧绘制一个蓝色正方形</li>
<li>调用 <code>GetDC</code> 获取窗口的设备上下文（HDC），并使用 <code>SetPixel</code> 逐点打点绘图。通过 <code>Sleep(2)</code> 控制绘制速度，展示两个图形同时生长的动画效果</li>
<li><code>main</code> 函数利用 <code>WaitForSingleObject</code> 阻塞等待两个绘图线程执行完毕</li>
</ol>
<p><em>task_3 截图</em><br>
![[Pasted image 20251223154415.png]]</p>
<h3 id="task-4-在-linux-下利用线程实现-生产者-消费者-同步控制">task_4 在 Linux 下利用线程实现“生产者-消费者”同步控制</h3>
<p>task_4.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓冲区</span></span><br><span class="line"><span class="type">int</span> buffer[BUFFER_SIZE];</span><br><span class="line"><span class="type">int</span> in = <span class="number">0</span>;  <span class="comment">// 写入位置</span></span><br><span class="line"><span class="type">int</span> out = <span class="number">0</span>; <span class="comment">// 读取位置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号量和互斥锁</span></span><br><span class="line"><span class="type">sem_t</span> empty_slots; <span class="comment">// 空槽位数量</span></span><br><span class="line"><span class="type">sem_t</span> full_slots;  <span class="comment">// 满槽位数量 (即产品数量)</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex; <span class="comment">// 互斥锁，保护缓冲区</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">Producer</span><span class="params">(<span class="type">void</span>* arg)</span> </span>{</span><br><span class="line">    <span class="type">int</span> id = *(<span class="type">int</span>*)arg;</span><br><span class="line">    <span class="type">int</span> start_val = (id == <span class="number">1</span>) ? <span class="number">1000</span> : <span class="number">2000</span>;</span><br><span class="line">    <span class="type">int</span> end_val = (id == <span class="number">1</span>) ? <span class="number">1999</span> : <span class="number">2999</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start_val; i &lt;= end_val; ++i) {</span><br><span class="line">        <span class="type">int</span> data = i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机睡眠 100ms - 1s</span></span><br><span class="line">        <span class="built_in">usleep</span>((<span class="built_in">rand</span>() % <span class="number">900000</span>) + <span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待空槽位</span></span><br><span class="line">        <span class="built_in">sem_wait</span>(&amp;empty_slots);</span><br><span class="line">        <span class="comment">// 获取互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 放入数据</span></span><br><span class="line">        buffer[in] = data;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"[Producer "</span> &lt;&lt; id &lt;&lt; <span class="string">"] Produced: "</span> &lt;&lt; data &lt;&lt; <span class="string">" at index "</span> &lt;&lt; in &lt;&lt; std::endl;</span><br><span class="line">        in = (in + <span class="number">1</span>) % BUFFER_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line">        <span class="comment">// 增加满槽位信号量</span></span><br><span class="line">        <span class="built_in">sem_post</span>(&amp;full_slots);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者线程函数</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">Consumer</span><span class="params">(<span class="type">void</span>* arg)</span> </span>{</span><br><span class="line">    <span class="type">int</span> id = *(<span class="type">int</span>*)arg;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="comment">// 随机睡眠 100ms - 1s</span></span><br><span class="line">        <span class="built_in">usleep</span>((<span class="built_in">rand</span>() % <span class="number">900000</span>) + <span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待满槽位 (有产品)</span></span><br><span class="line">        <span class="built_in">sem_wait</span>(&amp;full_slots);</span><br><span class="line">        <span class="comment">// 获取互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取出数据</span></span><br><span class="line">        <span class="type">int</span> data = buffer[out];</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"    [Consumer "</span> &lt;&lt; id &lt;&lt; <span class="string">"] Consumed: "</span> &lt;&lt; data &lt;&lt; <span class="string">" from index "</span> &lt;&lt; out &lt;&lt; std::endl;</span><br><span class="line">        out = (out + <span class="number">1</span>) % BUFFER_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放互斥锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line">        <span class="comment">// 增加空槽位信号量</span></span><br><span class="line">        <span class="built_in">sem_post</span>(&amp;empty_slots);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 初始化信号量和互斥锁</span></span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;empty_slots, <span class="number">0</span>, BUFFER_SIZE); <span class="comment">// 初始空槽位为 10</span></span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;full_slots, <span class="number">0</span>, <span class="number">0</span>);            <span class="comment">// 初始产品数为 0</span></span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> p1, p2;</span><br><span class="line">    <span class="type">pthread_t</span> c1, c2, c3;</span><br><span class="line">    <span class="type">int</span> id1 = <span class="number">1</span>, id2 = <span class="number">2</span>, id3 = <span class="number">3</span>; <span class="comment">// 线程 ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建消费者 (先创建消费者或者生产者都可以)</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;c1, <span class="literal">NULL</span>, Consumer, &amp;id1);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;c2, <span class="literal">NULL</span>, Consumer, &amp;id2);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;c3, <span class="literal">NULL</span>, Consumer, &amp;id3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建生产者</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;p1, <span class="literal">NULL</span>, Producer, &amp;id1);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;p2, <span class="literal">NULL</span>, Producer, &amp;id2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待生产者结束 (消费者是死循环，这里主线程只等生产者)</span></span><br><span class="line">    <span class="built_in">pthread_join</span>(p1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(p2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理资源</span></span><br><span class="line">    <span class="built_in">sem_destroy</span>(&amp;empty_slots);</span><br><span class="line">    <span class="built_in">sem_destroy</span>(&amp;full_slots);</span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>g++ task_4.cpp -o task_4 -lpthread</p>
<ol>
<li>利用 <code>sem_t</code> 类型的两个信号量 <code>empty_slots</code>（空位）和 <code>full_slots</code>（产品数）来协调生产与消费的节奏</li>
<li>使用 <code>pthread_mutex_t</code> 互斥锁保护共享的循环缓冲区 <code>buffer</code> 以及索引变量 <code>in</code> 和 <code>out</code>。确保同一时刻只有一个线程可以操作缓冲区，避免竞态条件</li>
<li>生产者：调用 <code>sem_wait</code> 确认有空位后，获取互斥锁并将数据写入 <code>buffer[in]</code>。完成写入后通过 <code>sem_post</code> 增加产品计数，通知消费者可以读取</li>
<li>消费者：调用 <code>sem_wait</code> 确认有产品后，获取互斥锁从 <code>buffer[out]</code> 取出数据。处理完毕后通过 <code>sem_post</code> 增加空位计数，通知生产者缓冲区已有新空间</li>
<li>通过 <code>(index + 1) % BUFFER_SIZE</code> 的取模运算，实现固定大小数组的循环利用，使 <code>in</code> 和 <code>out</code> 指针在缓冲区内首尾相连地循环移动</li>
</ol>
<p><em>task_4 截图</em><br>
![[Pasted image 20251223154452.png]]</p>
<h3 id="task-6-在-linux-下模拟哲学家就餐-提供死锁和非死锁解法">task_6 在 Linux 下模拟哲学家就餐，提供死锁和非死锁解法</h3>
<p>task_6_gui.c</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ncurses.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PHILOSOPHER_NUM 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// 开关配置：</span></span><br><span class="line"><span class="comment">// 0 = 【死锁演示模式】(拿到左筷子后强制停顿 1s)</span></span><br><span class="line"><span class="comment">// 1 = 【非死锁解法模式】(使用 trylock 策略)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE_NO_DEADLOCK_SOLUTION 1</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> {</span></span><br><span class="line">    STATE_THINKING,    <span class="comment">// 思考 (Blue)</span></span><br><span class="line">    STATE_HUNGRY,      <span class="comment">// 饿了/等左筷子 (Yellow)</span></span><br><span class="line">    STATE_GOT_LEFT,    <span class="comment">// 拿到了左筷子/等右筷子 (Magenta)</span></span><br><span class="line">    STATE_EATING,      <span class="comment">// 吃饭 (Green)</span></span><br><span class="line">    STATE_GIVE_UP      <span class="comment">// 放弃并放下筷子 (Red blink)</span></span><br><span class="line">} State;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> chopsticks[PHILOSOPHER_NUM];</span><br><span class="line"><span class="type">pthread_mutex_t</span> screen_lock;</span><br><span class="line">State philo_states[PHILOSOPHER_NUM];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">random_sleep</span><span class="params">(<span class="type">int</span> min_ms, <span class="type">int</span> max_ms)</span> {</span><br><span class="line">    <span class="type">int</span> sleep_micros = (rand() % (max_ms - min_ms + <span class="number">1</span>) + min_ms) * <span class="number">1000</span>;</span><br><span class="line">    usleep(sleep_micros);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_interface</span><span class="params">()</span> {</span><br><span class="line">    pthread_mutex_lock(&amp;screen_lock);</span><br><span class="line"></span><br><span class="line">    mvprintw(<span class="number">1</span>, <span class="number">2</span>, <span class="string">"=== Philosopher's Dining (Ncurses GUI) ==="</span>);</span><br><span class="line">    <span class="keyword">if</span> (ENABLE_NO_DEADLOCK_SOLUTION)</span><br><span class="line">        mvprintw(<span class="number">3</span>, <span class="number">2</span>, <span class="string">"Mode: [NO DEADLOCK] (TryLock)"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        mvprintw(<span class="number">3</span>, <span class="number">2</span>, <span class="string">"Mode: [DEADLOCK DEMO] (Force Wait 1s)"</span>);</span><br><span class="line"></span><br><span class="line">    mvprintw(<span class="number">5</span>, <span class="number">5</span>, <span class="string">"ID   | Left Fork | Status            | Right Fork"</span>);</span><br><span class="line">    mvprintw(<span class="number">6</span>, <span class="number">5</span>, <span class="string">"-----|-----------|-------------------|-----------"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHILOSOPHER_NUM; i++) {</span><br><span class="line">        <span class="type">int</span> row = <span class="number">8</span> + i * <span class="number">2</span>;</span><br><span class="line">        mvprintw(row, <span class="number">5</span>, <span class="string">"[P%d]"</span>, i);</span><br><span class="line">        mvprintw(row, <span class="number">12</span>, <span class="string">"%d"</span>, i);</span><br><span class="line"></span><br><span class="line">        move(row, <span class="number">24</span>);</span><br><span class="line">        <span class="keyword">switch</span> (philo_states[i]) {</span><br><span class="line">            <span class="keyword">case</span> STATE_THINKING:</span><br><span class="line">                attron(COLOR_PAIR(<span class="number">1</span>)); printw(<span class="string">" Thinking...      "</span>); attroff(COLOR_PAIR(<span class="number">1</span>)); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STATE_HUNGRY:</span><br><span class="line">                attron(COLOR_PAIR(<span class="number">2</span>)); printw(<span class="string">" Waiting Left...  "</span>); attroff(COLOR_PAIR(<span class="number">2</span>)); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STATE_GOT_LEFT:</span><br><span class="line">                attron(COLOR_PAIR(<span class="number">3</span>)); printw(<span class="string">" HAS LEFT &gt; WAIT  "</span>); attroff(COLOR_PAIR(<span class="number">3</span>)); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STATE_EATING:</span><br><span class="line">                attron(COLOR_PAIR(<span class="number">4</span>)); printw(<span class="string">" ** EATING **     "</span>); attroff(COLOR_PAIR(<span class="number">4</span>)); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STATE_GIVE_UP:</span><br><span class="line">                attron(COLOR_PAIR(<span class="number">5</span>)); printw(<span class="string">" !! GIVE UP !!    "</span>); attroff(COLOR_PAIR(<span class="number">5</span>)); <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        mvprintw(row, <span class="number">44</span>, <span class="string">"%d"</span>, (i + <span class="number">1</span>) % PHILOSOPHER_NUM);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    mvprintw(<span class="number">20</span>, <span class="number">2</span>, <span class="string">"Press Ctrl+C to exit."</span>);</span><br><span class="line">    refresh();</span><br><span class="line">    pthread_mutex_unlock(&amp;screen_lock);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">update_state</span><span class="params">(<span class="type">int</span> id, State s)</span> {</span><br><span class="line">    philo_states[id] = s;</span><br><span class="line">    draw_interface();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">philosopher</span><span class="params">(<span class="type">void</span>* arg)</span> {</span><br><span class="line">    <span class="type">int</span> id = *(<span class="type">int</span>*)arg;</span><br><span class="line">    <span class="type">int</span> left = id;</span><br><span class="line">    <span class="type">int</span> right = (id + <span class="number">1</span>) % PHILOSOPHER_NUM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) {</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_NO_DEADLOCK_SOLUTION</span></span><br><span class="line">        <span class="comment">// ================= 【非死锁模式】 =================</span></span><br><span class="line">        update_state(id, STATE_THINKING);</span><br><span class="line">        random_sleep(<span class="number">100</span>, <span class="number">500</span>); <span class="comment">// 符合要求：100ms-500ms</span></span><br><span class="line"></span><br><span class="line">        update_state(id, STATE_HUNGRY);</span><br><span class="line">        <span class="comment">// 尝试拿左边</span></span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_lock(&amp;chopsticks[left]) == <span class="number">0</span>) {</span><br><span class="line">            update_state(id, STATE_GOT_LEFT);</span><br><span class="line">            random_sleep(<span class="number">100</span>, <span class="number">500</span>); <span class="comment">// 模拟拿起的动作</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试拿右边 (TryLock)</span></span><br><span class="line">            <span class="keyword">if</span> (pthread_mutex_trylock(&amp;chopsticks[right]) == <span class="number">0</span>) {</span><br><span class="line">                update_state(id, STATE_EATING);</span><br><span class="line">                random_sleep(<span class="number">100</span>, <span class="number">500</span>); <span class="comment">// 符合要求：吃饭 100ms-500ms</span></span><br><span class="line"></span><br><span class="line">                pthread_mutex_unlock(&amp;chopsticks[right]);</span><br><span class="line">                <span class="comment">// 放下右筷子后，状态暂回左手持有（瞬间）</span></span><br><span class="line">                update_state(id, STATE_GOT_LEFT);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 拿不到，放弃</span></span><br><span class="line">                update_state(id, STATE_GIVE_UP);</span><br><span class="line">                random_sleep(<span class="number">100</span>, <span class="number">500</span>); <span class="comment">// 展示放弃状态</span></span><br><span class="line">            }</span><br><span class="line">            pthread_mutex_unlock(&amp;chopsticks[left]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 放弃后稍作等待</span></span><br><span class="line">            random_sleep(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">        }</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">// ================= 【死锁模式】 =================</span></span><br><span class="line">        update_state(id, STATE_THINKING);</span><br><span class="line">        random_sleep(<span class="number">100</span>, <span class="number">500</span>); <span class="comment">// 符合要求：100ms-500ms</span></span><br><span class="line"></span><br><span class="line">        update_state(id, STATE_HUNGRY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 拿左边</span></span><br><span class="line">        pthread_mutex_lock(&amp;chopsticks[left]);</span><br><span class="line">        update_state(id, STATE_GOT_LEFT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 【致命停顿】：拿到左筷子后，强制等1秒</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 拿右边 (死锁发生点)</span></span><br><span class="line">        pthread_mutex_lock(&amp;chopsticks[right]);</span><br><span class="line"></span><br><span class="line">        update_state(id, STATE_EATING);</span><br><span class="line">        random_sleep(<span class="number">100</span>, <span class="number">500</span>); <span class="comment">// 符合要求：吃饭 100ms-500ms</span></span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;chopsticks[right]);</span><br><span class="line">        pthread_mutex_unlock(&amp;chopsticks[left]);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">finish</span><span class="params">(<span class="type">int</span> sig)</span> {</span><br><span class="line">    endwin();</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    signal(SIGINT, finish);</span><br><span class="line"></span><br><span class="line">    initscr();</span><br><span class="line">    cbreak();</span><br><span class="line">    noecho();</span><br><span class="line">    curs_set(<span class="number">0</span>);</span><br><span class="line">    start_color();</span><br><span class="line"></span><br><span class="line">    init_pair(<span class="number">1</span>, COLOR_BLUE, COLOR_BLACK);</span><br><span class="line">    init_pair(<span class="number">2</span>, COLOR_YELLOW, COLOR_BLACK);</span><br><span class="line">    init_pair(<span class="number">3</span>, COLOR_MAGENTA, COLOR_BLACK);</span><br><span class="line">    init_pair(<span class="number">4</span>, COLOR_GREEN, COLOR_BLACK);</span><br><span class="line">    init_pair(<span class="number">5</span>, COLOR_RED, COLOR_BLACK);</span><br><span class="line"></span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line">    pthread_mutex_init(&amp;screen_lock, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> philo[PHILOSOPHER_NUM];</span><br><span class="line">    <span class="type">int</span> ids[PHILOSOPHER_NUM];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHILOSOPHER_NUM; i++) {</span><br><span class="line">        pthread_mutex_init(&amp;chopsticks[i], <span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    draw_interface();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHILOSOPHER_NUM; i++) {</span><br><span class="line">        ids[i] = i;</span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;philo[i], <span class="literal">NULL</span>, philosopher, &amp;ids[i]) != <span class="number">0</span>) {</span><br><span class="line">            endwin();</span><br><span class="line">            perror(<span class="string">"Create thread failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PHILOSOPHER_NUM; i++) {</span><br><span class="line">        pthread_join(philo[i], <span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    endwin();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>gcc task_6_gui.c -o task_6_gui -lpthread -lncurses</p>
<p>利用 <code>ncurses</code> 库构建字符图形界面，实时显示每个哲学家的状态（思考、饥饿、持有左筷子、进食、放弃）。通过 <code>screen_lock</code> 确保多线程刷新界面时不会产生乱序</p>
<ul>
<li>死锁</li>
</ul>
<ol>
<li>哲学家先调用 <code>pthread_mutex_lock</code> 锁定左手筷子，随后强制执行 <code>sleep(1)</code></li>
<li>通过 <code>sleep(1)</code> 确保所有哲学家都已成功持有左手筷子，强制死锁（不加这个 <code>sleep(1)</code> 的话可能得等很久才会出现死锁）</li>
<li>哲学家再次调用 <code>pthread_mutex_lock</code> 锁定右手筷子。由于右侧筷子已被邻座哲学家作为“左手筷子”持有且不释放，导致所有线程永久阻塞</li>
</ol>
<ul>
<li>非死锁</li>
</ul>
<ol>
<li>哲学家锁定左手筷子后，改用 <code>pthread_mutex_trylock</code> 尝试获取右手筷子</li>
<li>如果右手筷子已被占用，<code>trylock</code> 会立即返回失败，哲学家随后会通过 <code>pthread_mutex_unlock</code> 释放已持有的左手筷子</li>
</ol>
<p><em>task_6 截图</em><br>
死锁：<br>
![[Pasted image 20251223154600.png]]</p>
<p>非死锁：<br>
![[Pasted image 20251223154530.png]]</p>
<h2 id="实验三">实验三</h2>
<h3 id="task-1-linux模拟实现-opt-fifo-lru-等淘汰算法">task_1 Linux模拟实现 OPT, FIFO, LRU 等淘汰算法</h3>
<p>task_1.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;climits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span> <span class="comment">// 新增：用于FIFO算法的队列</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LruAndOpt</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 设置页面大小为10</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> pageSize = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// 物理页框数量</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> frameCount = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getPageNumber</span><span class="params">(<span class="type">int</span> address)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> address / pageSize;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= FIFO 算法 (新增) =================</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Fifo</span><span class="params">(<span class="type">const</span> vector&lt;<span class="type">int</span>&gt;&amp; A)</span> </span>{</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>; <span class="comment">// 缺页计数</span></span><br><span class="line">        <span class="type">int</span> n = A.<span class="built_in">size</span>();</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; pageMap; <span class="comment">// 逻辑页 -&gt; 物理页框</span></span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q; <span class="comment">// 记录进入内存的顺序</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            <span class="type">int</span> page = <span class="built_in">getPageNumber</span>(A[i]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第一次访问特殊处理</span></span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) {</span><br><span class="line">                count++;</span><br><span class="line">                pageMap[page] = <span class="number">1</span>;</span><br><span class="line">                q.<span class="built_in">push</span>(page);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 如果页面不在内存中 (缺页)</span></span><br><span class="line">                <span class="keyword">if</span> (pageMap.<span class="built_in">find</span>(page) == pageMap.<span class="built_in">end</span>()) {</span><br><span class="line">                    count++;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果还有空闲物理页框</span></span><br><span class="line">                    <span class="keyword">if</span> (pageMap.<span class="built_in">size</span>() &lt; frameCount) {</span><br><span class="line">                        <span class="type">int</span> newFrameId = pageMap.<span class="built_in">size</span>() + <span class="number">1</span>;</span><br><span class="line">                        pageMap[page] = newFrameId;</span><br><span class="line">                        q.<span class="built_in">push</span>(page);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="comment">// 内存已满，需要置换</span></span><br><span class="line">                        <span class="comment">// FIFO 核心：淘汰最早进入队列的页面</span></span><br><span class="line">                        <span class="type">int</span> eliminate = q.<span class="built_in">front</span>();</span><br><span class="line">                        q.<span class="built_in">pop</span>();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 获取被淘汰页面的物理页框号，给新页面用</span></span><br><span class="line">                        <span class="type">int</span> phy = pageMap[eliminate];</span><br><span class="line">                        pageMap.<span class="built_in">erase</span>(eliminate);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 装入新页</span></span><br><span class="line">                        pageMap[page] = phy;</span><br><span class="line">                        q.<span class="built_in">push</span>(page);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 如果页面已经在内存中 (Hit)，FIFO 不做任何操作，也不改变队列顺序</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">"访问次数:"</span> &lt;&lt; n &lt;&lt; <span class="string">",缺页次数:"</span> &lt;&lt; count &lt;&lt; <span class="string">",缺页率:"</span>;</span><br><span class="line">        cout &lt;&lt; fixed &lt;&lt; <span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; ((<span class="type">double</span>)count / n * <span class="number">100</span>) &lt;&lt; <span class="string">"%"</span> &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= OPT 算法 =================</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Opt</span><span class="params">(<span class="type">const</span> vector&lt;<span class="type">int</span>&gt;&amp; A)</span> </span>{</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> n = A.<span class="built_in">size</span>();</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; pageMap;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            <span class="type">int</span> page = <span class="built_in">getPageNumber</span>(A[i]);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) {</span><br><span class="line">                count++;</span><br><span class="line">                pageMap[page] = <span class="number">1</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">if</span> (pageMap.<span class="built_in">find</span>(page) == pageMap.<span class="built_in">end</span>()) {</span><br><span class="line">                    count++;</span><br><span class="line">                    <span class="keyword">if</span> (pageMap.<span class="built_in">size</span>() &lt; frameCount) {</span><br><span class="line">                        pageMap[page] = pageMap.<span class="built_in">size</span>() + <span class="number">1</span>;</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="type">int</span> eliminate = <span class="number">0</span>;</span><br><span class="line">                        <span class="type">int</span> latest = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; [k, v] : pageMap) {</span><br><span class="line">                            <span class="type">bool</span> found = <span class="literal">false</span>;</span><br><span class="line">                            <span class="type">int</span> time = <span class="number">0</span>;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">int</span> j = i + <span class="number">1</span>; j &lt; n; j++) {</span><br><span class="line">                                <span class="keyword">if</span> (k == <span class="built_in">getPageNumber</span>(A[j])) {</span><br><span class="line">                                    found = <span class="literal">true</span>;</span><br><span class="line">                                    time = j;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (found) {</span><br><span class="line">                                <span class="keyword">if</span> (latest &lt; time) {</span><br><span class="line">                                    latest = time;</span><br><span class="line">                                    eliminate = k;</span><br><span class="line">                                }</span><br><span class="line">                            } <span class="keyword">else</span> {</span><br><span class="line">                                eliminate = k;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        <span class="type">int</span> phy = pageMap[eliminate];</span><br><span class="line">                        pageMap.<span class="built_in">erase</span>(eliminate);</span><br><span class="line">                        pageMap[page] = phy;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">"访问次数:"</span> &lt;&lt; n &lt;&lt; <span class="string">",缺页次数:"</span> &lt;&lt; count &lt;&lt; <span class="string">",缺页率:"</span>;</span><br><span class="line">        cout &lt;&lt; fixed &lt;&lt; <span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; ((<span class="type">double</span>)count / n * <span class="number">100</span>) &lt;&lt; <span class="string">"%"</span> &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= LRU 算法 =================</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Lru</span><span class="params">(<span class="type">const</span> vector&lt;<span class="type">int</span>&gt;&amp; A)</span> </span>{</span><br><span class="line">        <span class="type">int</span> n = A.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; pageMap;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">            <span class="type">int</span> page = <span class="built_in">getPageNumber</span>(A[i]);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) {</span><br><span class="line">                count++;</span><br><span class="line">                pageMap[page] = <span class="number">1</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">if</span> (pageMap.<span class="built_in">find</span>(page) == pageMap.<span class="built_in">end</span>()) {</span><br><span class="line">                    count++;</span><br><span class="line">                    <span class="keyword">if</span> (pageMap.<span class="built_in">size</span>() &lt; frameCount) {</span><br><span class="line">                        pageMap[page] = pageMap.<span class="built_in">size</span>() + <span class="number">1</span>;</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="type">int</span> eliminate = <span class="number">0</span>;</span><br><span class="line">                        <span class="type">int</span> latest = INT_MAX;</span><br><span class="line">                        <span class="type">int</span> k = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> j = i - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) {</span><br><span class="line">                            <span class="type">int</span> pastPage = <span class="built_in">getPageNumber</span>(A[j]);</span><br><span class="line">                            <span class="keyword">if</span> (pageMap.<span class="built_in">count</span>(pastPage) &amp;&amp; latest &gt; j) {</span><br><span class="line">                                latest = j;</span><br><span class="line">                                k++;</span><br><span class="line">                                eliminate = pastPage;</span><br><span class="line">                                <span class="keyword">if</span> (k == frameCount) {</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        <span class="type">int</span> phy = pageMap[eliminate];</span><br><span class="line">                        pageMap.<span class="built_in">erase</span>(eliminate);</span><br><span class="line">                        pageMap[page] = phy;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">"访问次数:"</span> &lt;&lt; n &lt;&lt; <span class="string">",缺页次数:"</span> &lt;&lt; count &lt;&lt; <span class="string">",缺页率:"</span>;</span><br><span class="line">        cout &lt;&lt; fixed &lt;&lt; <span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; ((<span class="type">double</span>)count / n * <span class="number">100</span>) &lt;&lt; <span class="string">"%"</span> &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">srand</span>((<span class="type">unsigned</span>)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    LruAndOpt lao;</span><br><span class="line">    cout &lt;&lt; <span class="string">"页面大小为10,物理页框共3个"</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"请输入访问序列的个数:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">if</span> (!(cin &gt;&gt; n)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">"请输入随机数的限制:"</span>;</span><br><span class="line">    <span class="type">int</span> limit;</span><br><span class="line">    cin &gt;&gt; limit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 随机序列</span></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">A1</span><span class="params">(n)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">        A1[i] = <span class="built_in">rand</span>() % limit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 顺序序列 (0, 1, 2, 3...)</span></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">A2</span><span class="params">(n)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">        A2[i] = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 循环序列 (模拟局部性，如 0, 1, 2...99, 0, 1...)</span></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">A3</span><span class="params">(n)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) {</span><br><span class="line">        A3[i] = i % <span class="number">100</span>; <span class="comment">// 假设循环范围</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">"=================OPT算法================="</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------随机序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Opt</span>(A1);</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------顺序序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Opt</span>(A2);</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------循环序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Opt</span>(A3);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; endl &lt;&lt; <span class="string">"=================FIFO算法================="</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------随机序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Fifo</span>(A1);</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------顺序序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Fifo</span>(A2);</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------循环序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Fifo</span>(A3);</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; endl &lt;&lt; <span class="string">"=================LRU算法================="</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------随机序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Lru</span>(A1);</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------顺序序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Lru</span>(A2);</span><br><span class="line">    cout &lt;&lt; <span class="string">"-----------------循环序列-----------------"</span> &lt;&lt; endl;</span><br><span class="line">    lao.<span class="built_in">Lru</span>(A3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>FIFO (先进先出)
<ul>
<li>原理：总是淘汰最早进入内存的页面。</li>
<li>实现：使用 <code>std::queue&lt;int&gt; q</code>。新页进来排在队尾，需要置换时直接弹出队首（<code>q.front()</code>）</li>
</ul>
</li>
<li>OPT (最佳置换算法)
<ul>
<li>原理：淘汰以后永不使用，或者在最长时间内不再被访问的页面</li>
<li>实现：代码会向后遍历数组 A（<code>for (int j = i + 1; j &lt; n; j++)</code>），寻找内存中哪个页面在未来最晚才被用到。</li>
</ul>
</li>
<li>LRU (最近最久未使用)
<ul>
<li>原理：淘汰最近一段时间内最久没有被使用的页面</li>
<li>实现：代码通过向后回溯（<code>for (int j = i - 1; j &gt;= 0; j--)</code>）来观察哪些页面最近刚用过，挑出那个最远没用的</li>
</ul>
</li>
</ul>
<p><em>task_1 截图</em><br>
![[Pasted image 20251229193709.png]]</p>
<h3 id="task-2-linux-下利用-proc-pid-pagemap-技术计算某个变量或函数虚拟地址对应的物理地址等信息">task_2 Linux 下利用 /proc/pid/pagemap 技术计算某个变量或函数虚拟地址对应的物理地址等信息</h3>
<p>task_2.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取物理地址 //va为虚拟内存地址</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">VA2PA</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> va)</span> </span>{</span><br><span class="line">    <span class="comment">//页面大小</span></span><br><span class="line">    <span class="type">size_t</span> pageSize = <span class="built_in">getpagesize</span>();</span><br><span class="line">    <span class="comment">//页号</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pageIndex = va / pageSize;</span><br><span class="line">    <span class="comment">//页内偏移</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> offset = va % pageSize;</span><br><span class="line">    FILE* fp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义用于接收读取结果的变量 (修复错误 A)</span></span><br><span class="line">    <span class="type">uint64_t</span> it;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Virtual Address: 0x%lx\n"</span>, va);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Page Index: 0x%lx\nPage Offset: 0x%lx\n"</span>, pageIndex, offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((fp = <span class="built_in">fopen</span>(<span class="string">"/proc/self/pagemap"</span>, <span class="string">"rb"</span>)) == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Error: Cannot open pagemap. Are you root?\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fileOffset = pageIndex * <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">fseek</span>(fp, fileOffset, SEEK_SET) != <span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Error: fseek failed!\n"</span>);</span><br><span class="line">        <span class="built_in">fclose</span>(fp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">fread</span>(&amp;it, <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>), <span class="number">1</span>, fp) != <span class="number">1</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Error: fread failed!\n"</span>);</span><br><span class="line">        <span class="built_in">fclose</span>(fp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第63位记录当前页面位置：1为在物理内存中，0表示不在物理内存中</span></span><br><span class="line">    <span class="comment">// 修复错误 C: 增加括号修正优先级</span></span><br><span class="line">    <span class="keyword">if</span>(((it &gt;&gt; <span class="number">63</span>) &amp; <span class="number">1</span>) == <span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Page Present is 0.\nNot in the Physical Memory.\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0-54位为物理页号</span></span><br><span class="line">    <span class="type">uint64_t</span> pPageIndex = (((<span class="type">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>) &amp; it;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Physical Page Index: 0x%"</span> PRIx64 <span class="string">"\n"</span>, pPageIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 物理地址 = 物理页号*页大小+页内偏移</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pa = pPageIndex * pageSize + offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Physical Address: 0x%lx\n\n"</span>, pa);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">max</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> a &gt;= b ? a : b;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"pid = %d\n"</span>, <span class="built_in">getpid</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Global variable a:\n"</span>);</span><br><span class="line">    <span class="built_in">VA2PA</span>((<span class="type">unsigned</span> <span class="type">long</span>)&amp;a);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Function max:\n"</span>);</span><br><span class="line">    <span class="built_in">VA2PA</span>((<span class="type">unsigned</span> <span class="type">long</span>)(<span class="type">void</span>*)&amp;max); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>main 函数
<ul>
<li>打印当前进程 ID</li>
<li>计算变量 a 虚拟地址对应的物理地址</li>
<li>打印函数 max 虚拟地址对应的物理地址</li>
</ul>
</li>
<li>VA2PA 函数
<ul>
<li>使用 <code>getpagesize()</code> 获取系统页大小（通常为 4KB），计算输入地址对应的虚拟页号 (VPN) 和页内偏移 (Offset)</li>
<li>打开 <code>/proc/self/pagemap</code>（内核提供的页表映射接口），利用 <code>fseek</code> 定位到对应页号的条目位置。计算公式为：<code>文件偏移量 = 虚拟页号 * 8字节</code></li>
<li>读取 8字节（64位）的页表条目数据 (<code>uint64_t</code>)</li>
<li>检查读取数据的<strong>第63位</strong>（Present Bit：为 1 表明页面在内存中</li>
<li>利用位掩码 (<code>0-54位</code>) 从条目中提取物理页框号 (PFN)</li>
<li>通过公式 <code>物理地址 = 物理页框号 * 页大小 + 页内偏移</code> 得出最终物理地址并打印。</li>
</ul>
</li>
</ul>
<p><em>task_2 截图</em><br>
![[Pasted image 20251229195404.png]]</p>
<h2 id="实验四">实验四</h2>
<h3 id="task-1-编写一个-linux-内核模块-并完成模块的安装-卸载等操作">task_1 编写一个 Linux 内核模块，并完成模块的安装/卸载等操作</h3>
<ul>
<li>Makefile</li>
</ul>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态获取当前运行的内核版本</span></span><br><span class="line">KVER := <span class="variable">$(<span class="built_in">shell</span> uname -r)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动指向对应的内核构建目录</span></span><br><span class="line">KDIR := /lib/modules/<span class="variable">$(KVER)</span>/build</span><br><span class="line"></span><br><span class="line">PWD := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定目标文件</span></span><br><span class="line">obj-m := ycg.o</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认编译动作</span></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">        make -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理编译生成的文件</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        make -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ycg.c</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/moduleparam.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *name = <span class="string">"changganyin"</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> times = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收命令行参数</span></span><br><span class="line">module_param(times, <span class="type">int</span>, <span class="number">0644</span>);</span><br><span class="line">module_param(name, charp, <span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; times; i++)</span><br><span class="line">        printk(KERN_ALERT <span class="string">"(%d) hello, %s!\n"</span>, i, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    printk(KERN_ALERT <span class="string">"Goodbye, %s!\n"</span>, name);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"Dual BSD/GPL"</span>);</span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></tbody></table></figure>
<p>代码逻辑：</p>
<ul>
<li>定义两个全局变量 <code>name</code> 和 <code>times</code>，并用 <code>module_param</code> 宏将这两个变量声明为模块参数</li>
<li>循环体内，调用内核日志函数 <code>printk</code>（级别为 <code>KERN_ALERT</code>），多次打印带有 <code>name</code> 变量的问候语</li>
</ul>
<p>模块的安装和卸载</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make <span class="comment"># 编译</span></span><br><span class="line"><span class="built_in">sudo</span> insmod ycg.ko name=<span class="string">"ycg"</span> <span class="built_in">times</span>=7 <span class="comment"># 安装模块</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> rmmod ycg <span class="comment"># 卸载模块</span></span><br></pre></td></tr></tbody></table></figure>
<p><em>task_1 截图</em><br>
![[Pasted image 20251230144542.png]]<br>
![[Pasted image 20251230144918.png]]</p>
<h3 id="task-2-在-linux-平台编写一个字符设备的驱动程序和测试用的应用程序">task_2 在 Linux 平台编写一个字符设备的驱动程序和测试用的应用程序</h3>
<ul>
<li>ycgDrive.c</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">drv</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">dev_t</span> ndev;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> ycg[<span class="number">32</span>]; </span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">drv_open</span><span class="params">(<span class="keyword">struct</span> inode *nd, <span class="keyword">struct</span> file *fp)</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> major = MAJOR(nd-&gt;i_rdev);</span><br><span class="line">    <span class="type">int</span> minor = MINOR(nd-&gt;i_rdev);</span><br><span class="line">    printk(KERN_EMERG <span class="string">"ycgDrive: open, major = %d, minor = %d\n"</span>, major, minor);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">drv_read</span><span class="params">(<span class="keyword">struct</span> file* fp, <span class="type">char</span> __user* u, <span class="type">size_t</span> sz, <span class="type">loff_t</span>* loff)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> res[<span class="number">32</span>];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> num1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> num2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> flag = <span class="literal">true</span>; <span class="comment">// true为加法, false为减法</span></span><br><span class="line">  </span><br><span class="line">    printk(KERN_EMERG <span class="string">"ycgDrive: read operation.\n"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 解析字符串逻辑 (例如 "10+20")，读取 ycg 缓冲区</span></span><br><span class="line">    <span class="keyword">while</span> (ycg[i] != <span class="string">'+'</span> &amp;&amp; ycg[i] != <span class="string">'-'</span> &amp;&amp; ycg[i] != <span class="string">'\0'</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(ycg[i] &gt;= <span class="string">'0'</span> &amp;&amp; ycg[i] &lt;= <span class="string">'9'</span>)</span><br><span class="line">            num1 = <span class="number">10</span> * num1 + (ycg[i] - <span class="string">'0'</span>);</span><br><span class="line">        i++;</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (ycg[i] == <span class="string">'-'</span>) flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (ycg[i] == <span class="string">'+'</span> || ycg[i] == <span class="string">'-'</span>) i++; <span class="comment">// 跳过符号位</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> (ycg[i] != <span class="string">'\0'</span>) </span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(ycg[i] &gt;= <span class="string">'0'</span> &amp;&amp; ycg[i] &lt;= <span class="string">'9'</span>)</span><br><span class="line">            num2 = <span class="number">10</span> * num2 + (ycg[i] - <span class="string">'0'</span>);</span><br><span class="line">        i++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag == <span class="literal">true</span>) </span><br><span class="line">    {</span><br><span class="line">        printk(KERN_EMERG <span class="string">"%d + %d = %d\n"</span>, num1, num2, num1 + num2);</span><br><span class="line">        <span class="built_in">sprintf</span>(res, <span class="string">"%d + %d = %d\n"</span>, num1, num2, num1 + num2);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        printk(KERN_EMERG <span class="string">"%d - %d = %d\n"</span>, num1, num2, num1 - num2);</span><br><span class="line">        <span class="built_in">sprintf</span>(res, <span class="string">"%d - %d = %d\n"</span>, num1, num2, num1 - num2);</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 将结果复制回用户空间</span></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(u, res, <span class="built_in">strlen</span>(res)))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">drv_write</span><span class="params">(<span class="keyword">struct</span> file* fp, <span class="type">const</span> <span class="type">char</span> __user * u, <span class="type">size_t</span> sz, <span class="type">loff_t</span>* loff)</span>{</span><br><span class="line">    printk(KERN_EMERG <span class="string">"ycgDrive: write operation.\n"</span>);</span><br><span class="line">    <span class="comment">// 从用户空间复制数据到内核缓冲区 ycg</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(ycg, u, sz))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    ycg[sz] = <span class="string">'\0'</span>; <span class="comment">// 确保字符串结束符</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定操作函数</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">drv_ops</span> =</span> </span><br><span class="line">{</span><br><span class="line">    .owner  =   THIS_MODULE,</span><br><span class="line">    .open   =   drv_open,  </span><br><span class="line">    .read   =   drv_read, </span><br><span class="line">    .write  =   drv_write,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">changganyinDrv_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    cdev_init(&amp;drv, &amp;drv_ops);</span><br><span class="line">    <span class="comment">// 动态申请设备号，设备名为 "ycgDrive"</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;ndev, <span class="number">0</span>, <span class="number">1</span>, <span class="string">"ycgDrive"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        printk(KERN_EMERG <span class="string">"ycgDrive: alloc_chrdev_region error.\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 打印申请到的主设备号</span></span><br><span class="line">    printk(KERN_EMERG <span class="string">"ycgDrive: major = %d, minor = %d\n"</span>, MAJOR(ndev), MINOR(ndev));</span><br><span class="line">  </span><br><span class="line">    ret = cdev_add(&amp;drv, ndev, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        printk(KERN_EMERG <span class="string">"ycgDrive: cdev_add error.\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">changganyinDrv_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">{</span><br><span class="line">    printk(<span class="string">"ycgDrive: exit process!\n"</span>);</span><br><span class="line">    cdev_del(&amp;drv);</span><br><span class="line">    unregister_chrdev_region(ndev, <span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">module_init(changganyinDrv_init);</span><br><span class="line">module_exit(changganyinDrv_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"YCG"</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>代码逻辑：</p>
<ul>
<li>使用全局内核缓冲区 <code>ycg[32]</code> 在 <code>write</code> 和 <code>read</code> 操作之间传递数据，实现对字符串算式的解析与计算</li>
<li>drv_write: 使用 <code>copy_from_user</code> 函数，将用户空间传入的算式字符串（如 <code>"10+20"</code>）安全地复制到内核空间的全局数组 <code>ycg</code> 中，并手动添加字符串结束符 <code>\0</code>，为后续读取时的解析做准备</li>
<li>drv_read: 通过 <code>while</code> 循环遍历 <code>ycg</code> 缓冲区中的字符串，把两个数字分别赋值个 <code>num1</code> 和 <code>num2</code>，使用 <code>sprintf</code> 将结果格式化为字符串（如 <code>"10 + 20 = 30\n"</code>），最后通过 <code>copy_to_user</code> 将计算结果返回给用户空间</li>
<li>changganyinDrv_init: 动态分配设备号</li>
<li>task_2.c</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHAR_DEV_NAME <span class="string">"/dev/ycgDrive"</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> calc[<span class="number">32</span>];</span><br><span class="line"><span class="type">char</span> res[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打开设备文件</span></span><br><span class="line">    fd = open(CHAR_DEV_NAME, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"open failed! path: %s\n"</span>, CHAR_DEV_NAME);</span><br><span class="line">        perror(<span class="string">"reason"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input calculation (e.g. 1+1 or 10-5): "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>, calc);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. 写数据给驱动</span></span><br><span class="line">    write(fd, calc, <span class="built_in">strlen</span>(calc));</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 从驱动读结果</span></span><br><span class="line">    read(fd, res, <span class="number">32</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Result from kernel: %s\n"</span>, res);</span><br><span class="line">  </span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Makefile</li>
</ul>
<figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 动态获取当前内核版本</span></span><br><span class="line">KVER := <span class="variable">$(<span class="built_in">shell</span> uname -r)</span></span><br><span class="line">KDIR := /lib/modules/<span class="variable">$(KVER)</span>/build</span><br><span class="line">PWD  := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"></span><br><span class="line">obj-m := ycgDrive.o</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">	<span class="comment"># 编译内核模块</span></span><br><span class="line">	make -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line">	<span class="comment"># 编译测试应用程序</span></span><br><span class="line">	gcc -o task_2 task_2.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	make -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> clean</span><br><span class="line">	rm -rf task_2</span><br></pre></td></tr></tbody></table></figure>
<p>安装和卸载驱动程序</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make <span class="comment"># 编译</span></span><br><span class="line"><span class="built_in">sudo</span> insmod ycgDrive.ko <span class="comment"># 安装驱动程序</span></span><br><span class="line"><span class="built_in">sudo</span> dmesg | <span class="built_in">tail</span> -5</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> /dev/ycgDrive c 240 0 <span class="comment"># 根据上一步的结果</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /dev/ycgDrive</span><br><span class="line"><span class="built_in">sudo</span> rmmod ycgDrive</span><br><span class="line"><span class="built_in">sudo</span> dmesg | <span class="built_in">tail</span> -7</span><br></pre></td></tr></tbody></table></figure>
<p><em>taask_2 截图</em><br>
![[Pasted image 20251230145821.png]]<br>
![[Pasted image 20251230150249.png]]<br>
![[Pasted image 20251230150451.png]]</p>
<h3 id="task-3-实现-proc-接口-将应用程序和驱动程序的部分交互信息写入proc文件系统-并在应用程序快结束时读出相关文件信息并显示出来">task_3 实现 proc 接口，将应用程序和驱动程序的部分交互信息写入proc文件系统，并在应用程序快结束时读出相关文件信息并显示出来</h3>
<ul>
<li>ycgDrive2.c</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> src[<span class="number">256</span>];</span><br><span class="line"><span class="type">char</span> dest[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> length, count;</span><br><span class="line">    <span class="comment">// 打开设备，注意名字改成了 ycgDrive2</span></span><br><span class="line">    <span class="type">int</span> fp = open(<span class="string">"/dev/ycgDrive2"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fp &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Open ycgDrive2 fail. Did you run mknod?\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please write strings (Press Ctrl+D to stop writing):\n"</span>);</span><br><span class="line">    <span class="comment">// 循环写入</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%s"</span>, src) != EOF) {</span><br><span class="line">        length = <span class="built_in">strlen</span>(src);</span><br><span class="line">        count = write(fp, src, length);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Write to ycgDrive2 %dB\n"</span>, count);</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 清除 EOF 状态，为了后面的 scanf 能继续工作 (这是一个小技巧，否则后面的 scanf 会直接跳过)</span></span><br><span class="line">    clearerr(<span class="built_in">stdin</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置文件指针到开头</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\nReset file pointer to beginning...\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"position: %ld\n"</span>, lseek(fp, <span class="number">0</span>, SEEK_SET));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input the bytes to read (Press Ctrl+D to exit):\n"</span>);</span><br><span class="line">    <span class="comment">// 循环读取</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;length) != EOF) {</span><br><span class="line">        <span class="comment">// 读取指定长度</span></span><br><span class="line">        count = read(fp, dest, length);</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) {</span><br><span class="line">            dest[count] = <span class="number">0</span>; <span class="comment">// 添加字符串结束符</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Read from ycgDrive2 %dB: %s\n"</span>, count, dest);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Read 0 bytes (End of Buffer)\n"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    close(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>代码逻辑：</p>
<ul>
<li>ycgDrive2_llseek: 根据 <code>whence</code> 参数（<code>SEEK_SET</code> 头、<code>SEEK_CUR</code> 当前、<code>SEEK_END</code> 尾），计算新的文件指针位置 <code>newpos</code>; 修改文件结构体中的 <code>fp-&gt;f_pos</code>，从而改变下一次读写操作的位置</li>
<li>read/write: 将数据从用户空间复制到内核缓冲区。关键在于它会根据当前的<strong>文件指针偏移量 (<code>*pos</code>)</strong> 进行写入，并更新文件大小 (<code>ycgDrive2_size</code>)；根据当前的<strong>文件指针偏移量</strong>，从内核缓冲区的对应位置读取数据返回给用户</li>
<li>task_3.c</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> src[<span class="number">256</span>];</span><br><span class="line"><span class="type">char</span> dest[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> length, count;</span><br><span class="line">    <span class="type">int</span> fp = open(<span class="string">"/dev/ycgDrive2"</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fp &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Open ycgDrive2 fail. Did you run mknod?\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please write strings (Press Ctrl+D to stop writing):\n"</span>);</span><br><span class="line">    <span class="comment">// 循环写入</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%s"</span>, src) != EOF) {</span><br><span class="line">        length = <span class="built_in">strlen</span>(src);</span><br><span class="line">        count = write(fp, src, length);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Write to ycgDrive2 %dB\n"</span>, count);</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 清除 EOF 状态，为了后面的 scanf 能继续工作 (这是一个小技巧，否则后面的 scanf 会直接跳过)</span></span><br><span class="line">    clearerr(<span class="built_in">stdin</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置文件指针到开头</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\nReset file pointer to beginning...\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"position: %ld\n"</span>, lseek(fp, <span class="number">0</span>, SEEK_SET));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Please input the bytes to read (Press Ctrl+D to exit):\n"</span>);</span><br><span class="line">    <span class="comment">// 循环读取</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;length) != EOF) {</span><br><span class="line">        <span class="comment">// 读取指定长度</span></span><br><span class="line">        count = read(fp, dest, length);</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) {</span><br><span class="line">            dest[count] = <span class="number">0</span>; <span class="comment">// 添加字符串结束符</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Read from ycgDrive2 %dB: %s\n"</span>, count, dest);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Read 0 bytes (End of Buffer)\n"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    close(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>安装和卸载</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">make <span class="comment"># 编译</span></span><br><span class="line"><span class="built_in">sudo</span> insmod ycgDrive2.ko</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mknod</span> /dev/ycgDrive2 c 222 0</span><br><span class="line"><span class="built_in">sudo</span> ./task_3</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> /dev/ycgDrive2</span><br><span class="line"><span class="built_in">sudo</span> rmmod ycgDrive2</span><br></pre></td></tr></tbody></table></figure>
<p><em>task_3 截图</em><br>
![[Pasted image 20251230151345.png]]</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Changgan Yin</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://changganyin.github.io/2026/01/03/operating-system/">https://changganyin.github.io/2026/01/03/operating-system/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Changgan Yin</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/HUST/">
                                    <span class="chip bg-color">HUST</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2026/01/03/system-safety/">
                    <div class="card-image">
                        
                        <img src="https://mp-b6045dcf-2927-4865-9325-f14fa0979d3b.cdn.bspapp.com/classss.jpg" class="responsive-img" alt="System Safety">
                        
                        <span class="card-title">System Safety</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            华科《系统安全实验》
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2026-01-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Study/" class="post-category">
                                    Study
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/HUST/">
                        <span class="chip bg-color">HUST</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2026/01/03/network-security/">
                    <div class="card-image">
                        
                        <img src="https://mp-b6045dcf-2927-4865-9325-f14fa0979d3b.cdn.bspapp.com/classss.jpg" class="responsive-img" alt="Network Security">
                        
                        <span class="card-title">Network Security</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            华科《计算机网络安全实验》
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2026-01-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Study/" class="post-category">
                                    Study
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/HUST/">
                        <span class="chip bg-color">HUST</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2025-2026</span>
            
            <a href="/about" target="_blank">Changgan Yin</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
                <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;Total Words:&nbsp;<span
                        class="white-color">14.4k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2025";
                        var startMonth = "2";
                        var startDate = "28";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'en';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/changganyin" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:changganyin@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=670564647" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 670564647" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        <script type="text/javascript" src="/js/tw_cn.js"></script>
        <script type="text/javascript">
          var defaultEncoding = 2; //网站编写字体是否繁体，1-繁体，2-简体
          var translateDelay = 0; //延迟时间,若不在前, 要设定延迟翻译时间, 如100表示100ms,默认为0
          var cookieDomain = "https://changganyin.github.io"; //Cookie地址, 一定要设定, 通常为你的网址
          var msgToTraditionalChinese = "繁"; //此处可以更改为你想要显示的文字
          var msgToSimplifiedChinese = "简"; //同上，但两处均不建议更改
          var translateButtonId = "translateLink"; //默认互换id
          translateInitilization();
        </script>
    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
